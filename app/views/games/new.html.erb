<%= render 'board' %>
<%= render 'live_games' %>

<script>
var dispatcher = new WebSocketRails('chess-ryandgoldenberg1.c9.io/websocket');
dispatcher.on_open = function() {
  var user_id = $('#user-data').data('id');
  
  $('#play').on('click', function() {
    var data = {user_id: user_id};
    $(this).hide().prop('disabled', true);
    dispatcher.trigger('seek', data);
  });
  
  dispatcher.bind('new_game', function(data) {
    var color = (data.white_id === user_id ? 'white' : 'black');
    var data = $.extend({}, data, {color: color});
    newGame(data, dispatcher);
  });
  
  dispatcher.bind('live_games', function(data) {
    console.log('updating live_games...');
    
    var table = $('#live_games');
    data.forEach(function(game) {
      console.log(game);
      var row = $('<tr>');
      row.append( $('<td>').text(game.time_control.toString() + "-min") );
      row.append( $('<td>').text(game.player_info.white_name) );
      row.append( $('<td>').text(game.player_info.black_name) );
      row.append( 
        $('<button>', {
          class: 'watch',
          text: 'Watch Game',
          data: {'channel': game.channel_name}
        })
      );
      table.append(row);
    });
  });
};
</script>